name: Prepare Release
on:
  workflow_dispatch:
    inputs:
      version:
        required: false
        description: 'Next version (Use "custom" for specific versions like beta)'
        type: choice
        default: minor
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        required: false
        description: 'Custom version (e.g., 1.19.0-beta.1) - Only used when version is set to "custom"'
        type: string
jobs:
  prepare-release:
    name: Prepare Release PR
    runs-on: ubuntu-latest
    # Temporarily disabled for testing on feature branch
    # if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up git config
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global pull.rebase false
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'yarn'
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Run tests
        run: yarn test --run
      - name: Build
        run: yarn build
      - id: changelog
        name: Generate CHANGELOG
        uses: reearth/changelog-action@main
        with:
          version: ${{ github.event.inputs.version == 'custom' && github.event.inputs.custom_version || github.event.inputs.version }}
          repo: ${{ github.repository }}
          latest: CHANGELOG_latest.md
      - name: Upload latest CHANGELOG
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: changelog-${{ steps.changelog.outputs.version }}
          path: CHANGELOG_latest.md
      - name: Create release branch and PR
        env:
          VERSION: ${{ github.event.inputs.version == 'custom' && github.event.inputs.custom_version || steps.changelog.outputs.version }}
          TAG: v${{ github.event.inputs.version == 'custom' && github.event.inputs.custom_version || steps.changelog.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create release branch
          BRANCH="chore/release-${VERSION}"
          git checkout -b $BRANCH

          # Remove temporary changelog file
          rm CHANGELOG_latest.md

          # Commit changes
          git add CHANGELOG.md package.json
          git commit -m "chore: release ${TAG}"

          # Push branch
          git push origin $BRANCH

          # Create PR
          gh pr create \
            --title "chore: release ${TAG}" \
            --body "$(cat <<EOF
          ## Release ${TAG}

          This PR prepares the release for version ${VERSION}.

          ### Changes
          - Updated version in package.json to ${VERSION}
          - Auto-generated CHANGELOG from commits

          ### Next Steps
          1. Review the CHANGELOG changes
          2. Merge this PR to main
          3. Create a GitHub release with tag ${TAG}
          4. Publish to npm with \`npm publish\`

          ---
          ðŸ¤– Generated by automated release workflow
          EOF
          )" \
            --base main \
            --head $BRANCH
