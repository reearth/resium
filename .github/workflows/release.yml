name: Prepare Release
on:
  workflow_dispatch:
    inputs:
      version:
        required: false
        description: 'Next version (Use "custom" for specific versions like beta)'
        type: choice
        default: minor
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        required: false
        description: 'Custom version (e.g., 1.19.0-beta.1) - Only used when version is set to "custom"'
        type: string
jobs:
  prepare-release:
    name: Prepare Release PR
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}
      - name: Set up git config
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global pull.rebase false
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: "yarn"
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Run tests
        run: yarn test --run
      - name: Build
        run: yarn build
      - name: Get current version from package.json
        id: current_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
      - id: changelog
        name: Generate CHANGELOG
        uses: reearth/changelog-action@main
        with:
          version: ${{ github.event.inputs.version == 'custom' && github.event.inputs.custom_version || github.event.inputs.version }}
          repo: ${{ github.repository }}
          latest: CHANGELOG_latest.md
          from: v${{ steps.current_version.outputs.current }}
      - name: Upload latest CHANGELOG
        uses: actions/upload-artifact@v5
        with:
          name: changelog-${{ steps.changelog.outputs.version }}
          path: CHANGELOG_latest.md
      - name: Update package.json version
        run: |
          if [ "${{ github.event.inputs.version }}" = "custom" ]; then
            # For custom versions, use the exact version provided
            npm version "${{ github.event.inputs.custom_version }}" --no-git-tag-version
          else
            # For patch/minor/major, let npm calculate the new version
            npm version "${{ github.event.inputs.version }}" --no-git-tag-version
          fi
      - name: Create release branch and PR
        env:
          VERSION: ${{ github.event.inputs.version == 'custom' && github.event.inputs.custom_version || steps.changelog.outputs.version }}
          TAG: v${{ github.event.inputs.version == 'custom' && github.event.inputs.custom_version || steps.changelog.outputs.version }}
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          # Create release branch
          BRANCH="chore/release-${VERSION}"

          # Delete existing branch if it exists (locally and remotely)
          git branch -D $BRANCH 2>/dev/null || true
          git push origin --delete $BRANCH 2>/dev/null || true

          # Create new release branch
          git checkout -b $BRANCH

          # Remove temporary changelog file
          rm CHANGELOG_latest.md

          # Commit changes
          git add CHANGELOG.md package.json
          git commit -m "chore: release ${TAG}"

          # Push branch
          git push origin $BRANCH

          # Create PR
          gh pr create \
            --title "chore: release ${TAG}" \
            --body "$(cat <<EOF
          ## Release ${TAG}

          This PR prepares the release for version ${VERSION}.

          ### Changes
          - Updated version in package.json to ${VERSION}
          - Auto-generated CHANGELOG from commits

          ### Next Steps
          1. Review the CHANGELOG changes
          2. Merge this PR to main
          3. Create a GitHub release with tag ${TAG}
          4. Publish to npm with \`npm publish\`

          ---
          ðŸ¤– Generated by automated release workflow
          EOF
          )" \
            --base main \
            --head $BRANCH
