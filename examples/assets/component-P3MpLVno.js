var te=Object.defineProperty;var re=(t,e,n)=>e in t?te(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var w=(t,e,n)=>(re(t,typeof e!="symbol"?e+"":e,n),n);import{j as N}from"./jsx-runtime-BjG_zV1W.js";import{r as c}from"./index-yIsmwZOr.js";const ne=c.createContext({}),se=()=>c.useContext(ne)||{};function ie(t,e){return e?B(t).reduce((n,[r,o])=>(Q(e,r)&&(n[r]=o),n),{}):{}}function B(t){return Object.keys(t).map(e=>[e,t[e]])}function Q(t,e){return!!t&&t.indexOf(e)!==-1}function oe(t,e){return!!t&&!!e&&[...Object.keys(t),...Object.keys(e)].every(n=>t[n]===e[n])}function ce(t){return t&&typeof t.isDestroyed=="function"&&typeof t.destroy=="function"}function ue(t){return ce(t)&&t.isDestroyed()}function Y(t){return t&&typeof t=="object"&&"then"in t&&typeof t.then=="function"}const W="__RESIUM_EVENT_MANAGER",J=["onClick","onDoubleClick","onMouseDown","onMouseUp","onMiddleClick","onMiddleDown","onMiddleUp","onMouseMove","onPinchEnd","onPinchMove","onPinchStart","onRightClick","onRightDown","onRightUp","onWheel","onMouseEnter","onMouseLeave"],K=class K{constructor(e){w(this,"scene");w(this,"sshe");w(this,"events",{onClick:new Map,onDoubleClick:new Map,onMouseDown:new Map,onMouseUp:new Map,onMiddleClick:new Map,onMiddleDown:new Map,onMiddleUp:new Map,onMouseMove:new Map,onPinchEnd:new Map,onPinchMove:new Map,onPinchStart:new Map,onRightClick:new Map,onRightDown:new Map,onRightUp:new Map,onWheel:new Map,onMouseEnter:new Map,onMouseLeave:new Map});w(this,"hovered");w(this,"onMouseMove",e=>{var r,o,u,h,E,M;const n=this.pick(e.endPosition);this.hovered!==n&&(this.hovered&&((r=this.getEventCallback("onMouseLeave",this.hovered))==null||r(e,this.hovered),(o=this.getEventCallback("onMouseLeave",null))==null||o(e,this.hovered)),n&&((u=this.getEventCallback("onMouseEnter",n))==null||u(e,n),(h=this.getEventCallback("onMouseEnter",null))==null||h(e,n))),n&&((E=this.getEventCallback("onMouseMove",n))==null||E(e,n)),(M=this.getEventCallback("onMouseMove",null))==null||M(e,n),this.hovered=n});w(this,"eventCallback",e=>n=>{var o,u;const r=this.pick(n==null?void 0:n.position);r&&((o=this.getEventCallback(e,r))==null||o(n,r)),(u=this.getEventCallback(e,null))==null||u(n,r)});this.scene=e,this.sshe=new Cesium.ScreenSpaceEventHandler(e==null?void 0:e.canvas)}destroy(){this.hovered=void 0,this.sshe.isDestroyed()||this.sshe.destroy()}isDestroyed(){return this.sshe.isDestroyed()}on(e,n,r){e&&n==="onWheel"||this.events[n].set(e,r)}off(e,n){this.events[n].delete(e),this.hovered===e&&(this.hovered=void 0)}setEvents(e,n){B(n).forEach(([r,o])=>{const u=r;Q(J,u)&&(o?this.on(e,u,o):this.off(e,u))}),this.commit()}clearEvents(e){this.hovered=void 0,J.forEach(n=>{this.off(e,n)}),this.commit()}commit(){const e=this.sshe,n=this.sshe.isDestroyed();n||(this.events.onMouseEnter.size===0&&this.events.onMouseLeave.size===0&&this.events.onMouseMove.size===0?this.sshe.removeInputAction(Cesium.ScreenSpaceEventType.MOUSE_MOVE):this.sshe.getInputAction(Cesium.ScreenSpaceEventType.MOUSE_MOVE)||this.sshe.setInputAction(this.onMouseMove,Cesium.ScreenSpaceEventType.MOUSE_MOVE)),B(this.events).forEach(([r,o])=>{if(r==="onMouseEnter"||r==="onMouseLeave"||r==="onMouseMove")return;const u=K.eventTypeMap[r];n||(o.size===0?e.removeInputAction(u):e.getInputAction(u)||e.setInputAction(this.eventCallback(r),u))})}getScreenSpaceEventHandler(){return this.sshe}getEventCallback(e,n){var r,o;return n===null?this.events[e].get(null):this.events[e].get(n.id)||this.events[e].get((o=(r=n.id)==null?void 0:r.entityCollection)==null?void 0:o.owner)||this.events[e].get(n.primitive)||this.events[e].get(n.tileset)}pick(e){var n;if(e)return(n=this.scene)==null?void 0:n.pick(e)}};w(K,"eventTypeMap",{onClick:Cesium.ScreenSpaceEventType.LEFT_CLICK,onDoubleClick:Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK,onMouseDown:Cesium.ScreenSpaceEventType.LEFT_DOWN,onMouseUp:Cesium.ScreenSpaceEventType.LEFT_UP,onMiddleClick:Cesium.ScreenSpaceEventType.MIDDLE_CLICK,onMiddleDown:Cesium.ScreenSpaceEventType.MIDDLE_DOWN,onMiddleUp:Cesium.ScreenSpaceEventType.MIDDLE_UP,onMouseMove:Cesium.ScreenSpaceEventType.MOUSE_MOVE,onPinchEnd:Cesium.ScreenSpaceEventType.PINCH_END,onPinchMove:Cesium.ScreenSpaceEventType.PINCH_MOVE,onPinchStart:Cesium.ScreenSpaceEventType.PINCH_START,onRightClick:Cesium.ScreenSpaceEventType.RIGHT_CLICK,onRightDown:Cesium.ScreenSpaceEventType.RIGHT_DOWN,onRightUp:Cesium.ScreenSpaceEventType.RIGHT_UP,onWheel:Cesium.ScreenSpaceEventType.WHEEL,onMouseEnter:Cesium.ScreenSpaceEventType.MOUSE_MOVE,onMouseLeave:Cesium.ScreenSpaceEventType.MOUSE_MOVE});let Z=K;const ae=({name:t,create:e,destroy:n,provide:r,update:o,cesiumReadonlyProps:u,cesiumEventProps:h,otherProps:E,setCesiumPropsAfterCreate:M,useCommonEvent:T,useRootEvent:C},D,b)=>{const s=c.useRef(void 0),p=se(),g=c.useRef(r?{}:void 0),L=c.useRef({}),y=c.useRef(ee(D)),m=c.useRef({}),[R,X]=c.useState(!1),x=c.useRef(!1),V=c.useRef(null),A=c.useRef(void 0),H=p==null?void 0:p[W],k=c.useRef(void 0),_=c.useRef(void 0),P=c.useCallback(async l=>{var U;if(!s.current)return;const a=s.current,f=Object.keys(l),v=Object.keys(h||[]),S=f.concat(Object.keys(m.current).filter(i=>!f.includes(i))).filter(i=>m.current[i]!==l[i]).map(i=>[i,m.current[i],l[i]]),d=[];for(const[i,q,I]of S)if(u!=null&&u.includes(i))d.push(i);else if(Q(v,i)){const $=h==null?void 0:h[i],j=a[$];j instanceof Cesium.Event&&(typeof q>"u"?(j.addEventListener(I),L.current[$]=I):typeof I>"u"?(j.removeEventListener(q),delete L.current[$]):(j.removeEventListener(q),j.addEventListener(I)))}else i!=="children"&&!J.includes(i)&&!(E!=null&&E.includes(i))&&(a[i]=I);const O=C?(U=g.current)==null?void 0:U[W]:H;if(T&&O&&s.current&&O.setEvents(C?null:s.current,l),o&&x.current){const i=o(s.current,l,m.current,p);Y(i)&&await i}m.current=l,y.current=l,x.current&&d.length>0&&(z(),await G(),k.current=F())},[]),F=c.useCallback(async()=>{var v;await new Promise(S=>queueMicrotask(()=>S(void 0)));const l=e==null?void 0:e(p,y.current,V.current);let a;if(Y(l)?a=await l:a=l,Array.isArray(a)?(s.current=a[0],A.current=a[1]):s.current=a,M)await P(y.current);else{if(s.current&&h){const S=s.current;for(const d of Object.keys(y.current)){const O=h[d];if(O){const U=y.current[d],i=S[O];U&&i instanceof Cesium.Event&&i.addEventListener(U)}}}m.current=y.current}r&&s.current&&(g.current={...p,...r(s.current,p,D,A.current)});const f=C?(v=g.current)==null?void 0:v[W]:H;T&&f&&s.current&&f.setEvents(C?null:s.current,y.current),_.current||X(!0)},[]),z=c.useCallback(()=>{X(!1),x.current=!1},[]),G=c.useCallback(async()=>{var a,f;await new Promise(v=>queueMicrotask(()=>v(void 0))),k.current&&(await k.current,k.current=void 0),s.current&&n&&n(s.current,p,V.current,A.current);const l=C?(a=g.current)==null?void 0:a[W]:H;if(T&&l&&s.current&&l.clearEvents(C?null:s.current),s.current&&!ue(s.current)){const v=Object.keys(L.current);for(const S of v){const d=s.current[S];(f=d==null?void 0:d.removeEventListener)==null||f.call(d,L.current[S])}}L.current={},g.current=void 0,A.current=void 0,s.current=void 0},[]);return c.useLayoutEffect(()=>((async()=>{_.current&&(await _.current,_.current=void 0),k.current=F()})(),()=>{z(),_.current=G()}),[F,G,z]),c.useEffect(()=>{(async()=>{var f,v;k.current&&await k.current;const a=ee(D);R?oe(a,m.current)||(await P(a),(v=(f=p.__$internal)==null?void 0:f.onUpdate)==null||v.call(f)):(m.current=a,y.current=a,x.current=!0)})()},[p.__$internal,R,D,P]),c.useImperativeHandle(b,()=>({cesiumElement:R?s.current:null}),[R]),[g.current,R,V]};function ee(t){const{children:e,...n}=t;return n}const ve=({renderContainer:t,noChildren:e,containerProps:n,defaultProps:r,...o})=>{const u=(h,E)=>{const M={...r,...h},[T,C,D]=ae(o,M,E);if(e)return null;const b=C&&"children"in M?M.children:null,s=t?N.jsx("div",{"data-testid":"resium-container",ref:D,...typeof n=="function"?n(M):ie(M,n),children:b}):b?N.jsx(N.Fragment,{children:b}):null;return T?N.jsx(ne.Provider,{value:T,children:s}):s};return u.displayName=o.name,c.forwardRef(u)};export{Z as E,Q as a,ve as c,W as e,Y as i,se as u};
